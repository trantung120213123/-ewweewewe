<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyGen Nebula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background: radial-gradient(circle at center, #0a0f1f 0%, #020409 100%);
            overflow-x: hidden;
            font-family: 'Orbitron', sans-serif;
        }
        @keyframes neonGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.7), 0 0 30px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 1), 0 0 70px rgba(139, 92, 246, 0.8); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.12); }
            100% { transform: scale(1); }
        }
        @keyframes slideIn {
            from { transform: translateY(60px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes particle {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-150vh) scale(0.2); opacity: 0; }
        }
        @keyframes characterWalk {
            0% { background-position: 0 0; }
            100% { background-position: -256px 0; }
        }
        @keyframes characterFloat {
            0% { transform: translateY(0); }
            50% { transform: translateY(-25px); }
            100% { transform: translateY(0); }
        }
        @keyframes spaceshipFly {
            0% { transform: translateX(0) translateY(0) rotate(0deg); }
            50% { transform: translateX(80px) translateY(-40px) rotate(10deg); }
            100% { transform: translateX(0) translateY(0) rotate(0deg); }
        }
        @keyframes beamPulse {
            0% { opacity: 0.4; transform: scaleY(1); }
            50% { opacity: 0.9; transform: scaleY(1.4); }
            100% { opacity: 0.4; transform: scaleY(1); }
        }
        @keyframes orbGlow {
            0% { box-shadow: 0 0 12px rgba(236, 72, 153, 0.6); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 1), 0 0 50px rgba(236, 72, 153, 0.8); }
            100% { box-shadow: 0 0 12px rgba(236, 72, 153, 0.6); }
        }
        @keyframes nebulaCloud {
            0% { transform: translateX(0); opacity: 0.3; }
            50% { transform: translateX(-60px); opacity: 0.6; }
            100% { transform: translateX(0); opacity: 0.3; }
        }
        @keyframes textGlow {
            0% { text-shadow: 0 0 5px rgba(236, 72, 153, 0.5); }
            50% { text-shadow: 0 0 15px rgba(236, 72, 153, 1), 0 0 25px rgba(236, 72, 153, 0.7); }
            100% { text-shadow: 0 0 5px rgba(236, 72, 153, 0.5); }
        }
        @keyframes trailGlow {
            0% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 15px rgba(139, 92, 246, 1); }
            100% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.5); }
        }
        .neon-glow { animation: neonGlow 0.9s infinite; }
        .pulse { animation: pulse 1.3s infinite; }
        .slide-in { animation: slideIn 1.3s ease-out; }
        .text-glow { animation: textGlow 1.5s infinite; }
        .gradient-bg { background: linear-gradient(135deg, #f472b6 0%, #f87171 100%); }
        .card-bg { 
            background: rgba(17, 24, 39, 0.95); 
            backdrop-filter: blur(35px); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
        }
        .countdown { font-family: 'Space Mono', monospace; }
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(236, 72, 153, 1), transparent);
            border-radius: 50%;
            animation: particle 2.8s linear infinite, trailGlow 0.5s infinite;
            pointer-events: none;
        }
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 1.8s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .key-info {
            transition: all 0.5s ease;
        }
        .key-info:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-6px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }
        .character {
            position: absolute;
            width: 64px;
            height: 64px;
            background-size: 256px 64px;
            animation: characterWalk 0.5s steps(4) infinite, characterFloat 1.7s ease-in-out infinite;
            opacity: 0.5;
            pointer-events: none;
        }
        .spaceship {
            position: absolute;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            animation: spaceshipFly 3s ease-in-out infinite;
            opacity: 0.7;
            pointer-events: none;
        }
        .beam {
            position: absolute;
            width: 4px;
            height: 140px;
            background: linear-gradient(to bottom, rgba(139, 92, 246, 1), transparent);
            animation: beamPulse 1.6s infinite;
            pointer-events: none;
        }
        .orb {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ec4899 0%, transparent 70%);
            border-radius: 50%;
            animation: orbGlow 1s infinite;
            pointer-events: none;
        }
        .nebula {
            position: absolute;
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.4), transparent 70%);
            animation: nebulaCloud 8s ease-in-out infinite;
            pointer-events: none;
        }
        .history-table {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 92, 246, 0.5) transparent;
        }
        .history-table::-webkit-scrollbar {
            width: 6px;
        }
        .history-table::-webkit-scrollbar-track {
            background: transparent;
        }
        .history-table::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 3px;
        }
        .character-1 { background-image: url('https://opengameart.org/sites/default/files/hero_3.png'); }
        .character-2 { background-image: url('https://opengameart.org/sites/default/files/herochar_spritesheet.png'); }
        .spaceship-1 { background-image: url('https://opengameart.org/sites/default/files/spaceship_0.png'); }
        .spaceship-2 { background-image: url('https://opengameart.org/sites/default/files/spaceship_1.png'); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 relative">
    <!-- Animated Background Elements -->
    <div class="stars"></div>
    <div class="particles"></div>
    <div class="characters"></div>
    <div class="spaceships"></div>
    <div class="beams"></div>
    <div class="orbs"></div>
    <div class="nebulas"></div>

    <div class="w-full max-w-lg z-10">
        <!-- Header -->
        <div class="text-center mb-10 slide-in">
            <h1 class="text-6xl font-extrabold bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 bg-clip-text text-transparent tracking-tight text-glow">
                <i class="fas fa-rocket mr-3"></i>KeyGen Nebula
            </h1>
            <p class="text-gray-300 mt-3 text-xl font-light text-glow">Navigate the Cosmos with Your Secure Key</p>
        </div>

        <!-- Status Display -->
        <div id="statusDisplay" class="mb-8 hidden card-bg rounded-2xl p-8 neon-glow">
            <p id="statusText" class="text-gray-200 text-center text-lg"></p>
            <div id="countdownDisplay" class="countdown text-3xl font-bold text-pink-400 text-center mt-4"></div>
        </div>

        <!-- Key Display -->
        <div id="keyDisplay" class="hidden mb-8 card-bg rounded-2xl p-8 neon-glow">
            <h3 class="text-2xl font-semibold text-gray-200 mb-6 text-center text-glow">Current Nebula Key</h3>
            <div class="space-y-4">
                <div class="key-info bg-gray-900/50 rounded-lg p-4 flex items-center justify-between">
                    <span class="text-gray-400">Key</span>
                    <div class="flex items-center">
                        <code id="generatedKey" class="text-lg font-mono text-green-400 break-all mr-3"></code>
                        <button onclick="copyKey()" class="text-purple-400 hover:text-purple-300">
                            <i class="fas fa-copy text-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="key-info bg-gray-900/50 rounded-lg p-4 flex justify-between">
                    <span class="text-gray-400">Created At</span>
                    <span id="createdAt" class="text-gray-200"></span>
                </div>
                <div class="key-info bg-gray-900/50 rounded-lg p-4 flex justify-between">
                    <span class="text-gray-400">Expires At</span>
                    <span id="expiresAt" class="text-gray-200"></span>
                </div>
                <div class="key-info bg-gray-900/50 rounded-lg p-4 flex justify-between">
                    <span class="text-gray-400">Permanent</span>
                    <span id="permanentStatus" class="text-gray-200"></span>
                </div>
            </div>
        </div>

        <!-- Key History -->
        <div id="historyDisplay" class="hidden mb-8 card-bg rounded-2xl p-8 neon-glow">
            <h3 class="text-2xl font-semibold text-gray-200 mb-6 text-center text-glow">Key Generation History</h3>
            <div class="history-table">
                <table class="w-full text-gray-200 text-sm">
                    <thead>
                        <tr class="bg-gray-900/50">
                            <th class="py-2 px-4 text-left">Key</th>
                            <th class="py-2 px-4 text-left">Created At</th>
                            <th class="py-2 px-4 text-left">Expires At</th>
                            <th class="py-2 px-4 text-left">Permanent</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Action Button -->
        <div class="space-y-4">
            <button id="getKeyBtn" onclick="getKey()" 
                    class="w-full gradient-bg hover:from-purple-600 hover:to-pink-600 px-8 py-4 rounded-xl font-bold text-lg text-white transition-all duration-300 flex items-center justify-center shadow-2xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed neon-glow pulse hidden">
                <i class="fas fa-rocket mr-3"></i>Launch Nebula Key
            </button>
        </div>

        <!-- Footer -->
        <div class="text-center mt-10 text-gray-400 text-sm font-light">
            <p>Keys expire in 24 hours. 1-hour cooldown between requests.</p>
            <p class="mt-1">Powered by KeyGen Nebula &copy; 2025</p>
        </div>
    </div>

    <script>
        const API_BASE = 'https://serverluexreal.onrender.com';
        const statusDisplay = document.getElementById('statusDisplay');
        const statusText = document.getElementById('statusText');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const keyDisplay = document.getElementById('keyDisplay');
        const generatedKey = document.getElementById('generatedKey');
        const createdAt = document.getElementById('createdAt');
        const expiresAt = document.getElementById('expiresAt');
        const permanentStatus = document.getElementById('permanentStatus');
        const getKeyBtn = document.getElementById('getKeyBtn');
        const historyDisplay = document.getElementById('historyDisplay');
        const historyTable = document.getElementById('historyTable');
        let countdownInterval;
        let hwid = '';
        let currentKeyData = null;

        // Generate HWID
        function generateHWID() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '16px Orbitron';
            ctx.fillText('NEBULA_KEYGEN_2025', 2, 2);
            const data = canvas.toDataURL();
            hwid = btoa(data).substring(0, 16);
            return hwid;
        }

        // Check cooldown and key status
        async function checkTimeLeft() {
            const hwid = generateHWID();
            try {
                const response = await fetch(`${API_BASE}/check-time-left`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hwid })
                });
                const data = await response.json();

                if (data.can_request) {
                    statusText.textContent = 'Ready to launch your nebula key!';
                    countdownDisplay.textContent = '';
                    statusDisplay.classList.remove('hidden');
                    getKeyBtn.classList.remove('hidden');
                    getKeyBtn.disabled = false;
                    keyDisplay.classList.add('hidden');
                    showToast('Ready to generate a new key!', 'success');
                } else {
                    statusText.textContent = data.message;
                    statusDisplay.classList.remove('hidden');
                    getKeyBtn.classList.add('hidden');
                    getKeyBtn.disabled = true;
                    startCountdown(data.time_left * 3600);

                    // Check if there's a valid key
                    if (data.key && data.expires && new Date(data.expires) > new Date()) {
                        currentKeyData = data;
                        generatedKey.textContent = data.key;
                        createdAt.textContent = new Date(data.created_at).toLocaleString();
                        expiresAt.textContent = new Date(data.expires).toLocaleString();
                        permanentStatus.textContent = data.permanent ? 'Yes' : 'No';
                        keyDisplay.classList.remove('hidden');
                        showToast('Displaying your current valid key.', 'info');
                    } else {
                        keyDisplay.classList.add('hidden');
                        showToast(data.message, 'warning');
                    }
                }

                // Fetch key history
                await fetchKeyHistory();
            } catch (error) {
                console.error('Error checking time:', error);
                showToast('Failed to check cooldown. Please check server connection.', 'error');
            }
        }

        function startCountdown(seconds) {
            clearInterval(countdownInterval);
            updateCountdown(seconds);

            countdownInterval = setInterval(() => {
                seconds--;
                updateCountdown(seconds);
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    statusDisplay.classList.add('hidden');
                    getKeyBtn.classList.remove('hidden');
                    getKeyBtn.disabled = false;
                    showToast('Cooldown complete! Launch your key now.', 'success');
                    checkTimeLeft(); // Re-check to update UI
                }
            }, 1000);
        }

        function updateCountdown(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            countdownDisplay.textContent = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function getKey() {
            const hwid = generateHWID();
            try {
                getKeyBtn.disabled = true;
                getKeyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Launching...';

                const response = await fetch(`${API_BASE}/get-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hwid })
                });
                const data = await response.json();

                if (data.success) {
                    currentKeyData = data;
                    generatedKey.textContent = data.key;
                    createdAt.textContent = new Date().toLocaleString();
                    expiresAt.textContent = data.expires ? new Date(data.expires).toLocaleString() : 'N/A';
                    permanentStatus.textContent = data.permanent ? 'Yes' : 'No';
                    keyDisplay.classList.remove('hidden');
                    statusDisplay.classList.add('hidden');
                    getKeyBtn.classList.add('hidden');
                    clearInterval(countdownInterval);

                    // Store in localStorage as fallback
                    const localHistory = JSON.parse(localStorage.getItem('keyHistory') || '[]');
                    localHistory.push({
                        key: data.key,
                        created_at: new Date().toISOString(),
                        expires: data.expires,
                        permanent: data.permanent
                    });
                    localStorage.setItem('keyHistory', JSON.stringify(localHistory.slice(-10))); // Keep last 10 entries

                    showToast(`Key launched! Valid until ${data.expires ? new Date(data.expires).toLocaleString() : 'Permanent'}`, 'success');
                    await fetchKeyHistory();
                } else {
                    showToast(data.message || 'Failed to launch key', 'error');
                    if (data.time_left) {
                        statusText.textContent = data.message;
                        statusDisplay.classList.remove('hidden');
                        getKeyBtn.classList.add('hidden');
                        startCountdown(data.time_left * 3600);
                    }
                }
            } catch (error) {
                console.error('Error getting key:', error);
                showToast('Failed to launch key. Check server connection.', 'error');
            } finally {
                getKeyBtn.disabled = false;
                getKeyBtn.innerHTML = '<i class="fas fa-rocket mr-3"></i>Launch Nebula Key';
            }
        }

        async function fetchKeyHistory() {
            const hwid = generateHWID();
            try {
                const response = await fetch(`${API_BASE}/get-key-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hwid })
                });
                const data = await response.json();

                if (data.success && data.history && data.history.length > 0) {
                    historyTable.innerHTML = '';
                    data.history.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-800/50';
                        row.innerHTML = `
                            <td class="py-2 px-4">${item.key}</td>
                            <td class="py-2 px-4">${new Date(item.created_at).toLocaleString()}</td>
                            <td class="py-2 px-4">${item.expires ? new Date(item.expires).toLocaleString() : 'N/A'}</td>
                            <td class="py-2 px-4">${item.permanent ? 'Yes' : 'No'}</td>
                        `;
                        historyTable.appendChild(row);
                    });
                    historyDisplay.classList.remove('hidden');
                } else {
                    historyDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching key history:', error);
                historyDisplay.classList.add('hidden');
                // Fallback to localStorage
                const localHistory = JSON.parse(localStorage.getItem('keyHistory') || '[]');
                if (localHistory.length > 0) {
                    historyTable.innerHTML = '';
                    localHistory.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-800/50';
                        row.innerHTML = `
                            <td class="py-2 px-4">${item.key}</td>
                            <td class="py-2 px-4">${new Date(item.created_at).toLocaleString()}</td>
                            <td class="py-2 px-4">${item.expires ? new Date(item.expires).toLocaleString() : 'N/A'}</td>
                            <td class="py-2 px-4">${item.permanent ? 'Yes' : 'No'}</td>
                        `;
                        historyTable.appendChild(row);
                    });
                    historyDisplay.classList.remove('hidden');
                }
            }
        }

        function copyKey() {
            const keyText = generatedKey.textContent;
            navigator.clipboard.writeText(keyText).then(() => {
                showToast('Key copied to clipboard!', 'success');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = keyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Key copied to clipboard!', 'success');
            });
        }

        function showToast(message, type = 'info') {
            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600';

            Swal.fire({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                iconHtml: `<i class="${icon} text-2xl"></i>`,
                title: message,
                background: 'rgba(17, 24, 39, 0.95)',
                color: '#fff',
                customClass: {
                    popup: `border-l-4 ${bgColor} shadow-2xl rounded-xl`,
                    title: 'font-medium text-base'
                },
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        // Create animated background elements
        function createBackgroundEffects() {
            const starsContainer = document.querySelector('.stars');
            const particlesContainer = document.querySelector('.particles');
            const charactersContainer = document.querySelector('.characters');
            const spaceshipsContainer = document.querySelector('.spaceships');
            const beamsContainer = document.querySelector('.beams');
            const orbsContainer = document.querySelector('.orbs');
            const nebulasContainer = document.querySelector('.nebulas');

            // Stars
            for (let i = 0; i < 350; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 1.8}s`;
                starsContainer.appendChild(star);
            }

            // Particles
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 2.8}s`;
                particlesContainer.appendChild(particle);
            }

            // Characters
            const characterClasses = ['character-1', 'character-2'];
            const characterPositions = [
                { left: '5%', bottom: '10%' },
                { right: '5%', bottom: '15%' },
            ];
            for (let i = 0; i < characterClasses.length; i++) {
                const character = document.createElement('div');
                character.className = `character ${characterClasses[i]}`;
                character.style.left = characterPositions[i].left || 'auto';
                character.style.right = characterPositions[i].right || 'auto';
                character.style.bottom = characterPositions[i].bottom;
                character.style.animationDelay = `${Math.random() * 1.5}s`;
                charactersContainer.appendChild(character);
            }

            // Spaceships
            const spaceshipClasses = ['spaceship-1', 'spaceship-2'];
            const spaceshipPositions = [
                { left: '10%', top: '20%' },
                { right: '10%', top: '30%' },
            ];
            for (let i = 0; i < spaceshipClasses.length; i++) {
                const spaceship = document.createElement('div');
                spaceship.className = `spaceship ${spaceshipClasses[i]}`;
                spaceship.style.left = spaceshipPositions[i].left || 'auto';
                spaceship.style.right = spaceshipPositions[i].right || 'auto';
                spaceship.style.top = spaceshipPositions[i].top;
                spaceship.style.animationDelay = `${Math.random() * 2.5}s`;
                spaceshipsContainer.appendChild(spaceship);
            }

            // Beams
            for (let i = 0; i < 5; i++) {
                const beam = document.createElement('div');
                beam.className = 'beam';
                beam.style.left = `${10 + i * 20}%`;
                beam.style.top = `${Math.random() * 10}%`;
                beam.style.animationDelay = `${Math.random() * 1.6}s`;
                beamsContainer.appendChild(beam);
            }

            // Orbs
            for (let i = 0; i < 8; i++) {
                const orb = document.createElement('div');
                orb.className = 'orb';
                orb.style.left = `${Math.random() * 80 + 10}%`;
                orb.style.top = `${Math.random() * 60 + 20}%`;
                orb.style.animationDelay = `${Math.random() * 1}s`;
                orbsContainer.appendChild(orb);
            }

            // Nebulas
            for (let i = 0; i < 4; i++) {
                const nebula = document.createElement('div');
                nebula.className = 'nebula';
                nebula.style.left = `${Math.random() * 60 + 20}%`;
                nebula.style.top = `${Math.random() * 50 + 10}%`;
                nebula.style.animationDelay = `${Math.random() * 4}s`;
                nebulasContainer.appendChild(nebula);
            }
        }

        // Initialize
        window.onload = () => {
            createBackgroundEffects();
            checkTimeLeft();
        };
    </script>
</body>
</html>
